---
categories:
- paper-reviews
date: '2025-02-18 00:00:00'
description: "논문 리뷰 - LLM, \bPre-Training, MoE 관련 연구"
giscus_comments: true
layout: post
related_posts: false
tags:
- "\bpre-training"
- attention
- embedding
- llm
- moe
- paper-review
- reasoning
- rlhf
- transformer
thumbnail: assets/img/posts/2025-02-18-deepseek-v3/thumbnail.jpg
title: DeepSeek v3
---

**논문 정보**
- **Date**: 2025-02-18
- **Reviewer**: 김재희
- **Property**: LLM, Pre-Training, MoE

# 1. Intro

## Contribution

- MoE 학습 시 발생 가능한 overhead와 학습 불안정 요소 해소

- transformer 구조 변경을 통한 caching 효율화 방법론 제안

- Multi-Token Prediction을 통한 추가 학습 loss 이용

- 학습 인프라 최적화를 통한 분산학습 방법론 제안

- fill-in-the-middle 학습을 통한 추가적 모델 유연성 확보

- distillation 등을 통한 post-training 최적화

# 2. Architecture & Loss functions

## 2-1. 모델 구조

### 2-1-1. Overall Architecture

![Image](https://prod-files-secure.s3.us-west-2.amazonaws.com/3acbc979-3f43-48f4-8683-229c6104ec76/ea7ee40c-9e38-44e0-b5bb-53225a0eef43/image.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=ASIAZI2LB466UKSS5BAW%2F20250810%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20250810T113502Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJv%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJIMEYCIQCyqXwGTDP4S29JhLtZ9oqf7yovwew1VJu6EZpe%2FcFezQIhAOLbIBX9RQTjEPk3SbK4Ct6o6vqrEL2OEqAzXvR81VxfKogECNT%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEQABoMNjM3NDIzMTgzODA1Igxpx%2F8nNI4tSu2lnDoq3AN0C9bAgKvlZNPuFeJt5vM1GRs4MuoUO8TL%2FavUSorZgz6NUfTb6nTOjQITGrH8RfSECQskXmN4bdn7kk4jF%2B%2FpgDr9EgLOy%2FkNGgQIuIX5AmQP4j2wDSJq7XlrvbeXs7PD2z2OkEiEMDsptlfJpeKaYqF612hJrF3ILmDlkXkrO7K2rASaD1nqIO5S%2BoQa5VxFEo%2FE24oWcoliqNIFxJGMofch1WtCTN6HYYQeqbzrK83WVKosEwJAsTp6uJNzBXF1MRQOMFUkQOazPJGTTMQj5k5yL%2FQPZZLW0WxgOrV3DJM3qQMmCdvI%2F2X6Evvw%2F1Jk%2Bd2jBxtphgfqEGPc3kVFz4MdUfU%2FmkZsLKIB8IaGFH1%2BitSb8Gyo7hvNEwDQtXncxabpheWA95GFzlMRqLUY2nVVfxuTV5K6EUwCuN5yrAqm5eeKCduVKBODvA0Y7qP9r0aQUNESsIlYayAaEev0CWxo2IUnli3jeGgRfo6v4GsADe5Vmz7nVw%2FtY5YLNHel5k0wi1VxLEMagP68a8qRyMt3FzGcHQMe7oKYz%2FRFghaGu0DwUxGv%2FMQNMmHBEYemzktXjKa6TQkse9dqXnqQc4K%2FS5G8VzIqpQ%2FIMumf%2B%2FRe1f1Fr1NUNLImNzDO%2FuHEBjqkAcJUJS%2B2zL%2B3lcSFkg41yDaKtVqFyYNJ%2Fw510RgOTYYBfr9nhYXbtLUYGv6LwJNBa6plJgy8xQnylbEA%2FUABG0h9yzMy2lDZ9EaIQ0T3aHeSQTgxDl9WgjSPlY%2B4oTWwX74D%2BxTCt%2FTvg0gBLjRrsOwmN6UfO7yQhInnnGtf4QCHrDOnRzrF9gzlfpVKjOQ7icfETD70edqfTgTLIwwKKbwAOoTg&X-Amz-Signature=fa44912d517d7ef02b08e48ade901c8460a526cac0346e342692d64ad4247b66&X-Amz-SignedHeaders=host&x-amz-checksum-mode=ENABLED&x-id=GetObject)

- 기존 transformer 구조 거의 유지

- FFNN: MoE 구조 사용 → 존재하던 방법론

- Attention: Multi-head Latent Attention(MLA) 구조 사용 → 새롭게 제안

### 2-1-2. Mixture-of-Experts

- 기존에 널리 활용되던 MoE 구조 차용

- shared expert와 routed expert로 구분하여 사용 → DeepSeekMoE 논문 결과

- routing: sigmoid 함수를 이용하여 입력값에 대한 각 expert의 활용 점수(affinity score) 산출

![Image](https://prod-files-secure.s3.us-west-2.amazonaws.com/3acbc979-3f43-48f4-8683-229c6104ec76/062ac81d-988d-4dab-ac98-1f11f7910010/image.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=ASIAZI2LB466UKSS5BAW%2F20250810%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20250810T113502Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJv%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJIMEYCIQCyqXwGTDP4S29JhLtZ9oqf7yovwew1VJu6EZpe%2FcFezQIhAOLbIBX9RQTjEPk3SbK4Ct6o6vqrEL2OEqAzXvR81VxfKogECNT%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEQABoMNjM3NDIzMTgzODA1Igxpx%2F8nNI4tSu2lnDoq3AN0C9bAgKvlZNPuFeJt5vM1GRs4MuoUO8TL%2FavUSorZgz6NUfTb6nTOjQITGrH8RfSECQskXmN4bdn7kk4jF%2B%2FpgDr9EgLOy%2FkNGgQIuIX5AmQP4j2wDSJq7XlrvbeXs7PD2z2OkEiEMDsptlfJpeKaYqF612hJrF3ILmDlkXkrO7K2rASaD1nqIO5S%2BoQa5VxFEo%2FE24oWcoliqNIFxJGMofch1WtCTN6HYYQeqbzrK83WVKosEwJAsTp6uJNzBXF1MRQOMFUkQOazPJGTTMQj5k5yL%2FQPZZLW0WxgOrV3DJM3qQMmCdvI%2F2X6Evvw%2F1Jk%2Bd2jBxtphgfqEGPc3kVFz4MdUfU%2FmkZsLKIB8IaGFH1%2BitSb8Gyo7hvNEwDQtXncxabpheWA95GFzlMRqLUY2nVVfxuTV5K6EUwCuN5yrAqm5eeKCduVKBODvA0Y7qP9r0aQUNESsIlYayAaEev0CWxo2IUnli3jeGgRfo6v4GsADe5Vmz7nVw%2FtY5YLNHel5k0wi1VxLEMagP68a8qRyMt3FzGcHQMe7oKYz%2FRFghaGu0DwUxGv%2FMQNMmHBEYemzktXjKa6TQkse9dqXnqQc4K%2FS5G8VzIqpQ%2FIMumf%2B%2FRe1f1Fr1NUNLImNzDO%2FuHEBjqkAcJUJS%2B2zL%2B3lcSFkg41yDaKtVqFyYNJ%2Fw510RgOTYYBfr9nhYXbtLUYGv6LwJNBa6plJgy8xQnylbEA%2FUABG0h9yzMy2lDZ9EaIQ0T3aHeSQTgxDl9WgjSPlY%2B4oTWwX74D%2BxTCt%2FTvg0gBLjRrsOwmN6UfO7yQhInnnGtf4QCHrDOnRzrF9gzlfpVKjOQ7icfETD70edqfTgTLIwwKKbwAOoTg&X-Amz-Signature=a7a03f0f3068a53ef0ad916f6a54ceeaf61cdc3635e85a3575a80ae6bd51c660&X-Amz-SignedHeaders=host&x-amz-checksum-mode=ENABLED&x-id=GetObject)

### 2-1-3. Multi-head Latent Attention

KV Caching

- K, V Caching: 생성 시 과거 시점의 k, v representation을 caching하여 연산량을 절감하는 방법론

![Image](https://prod-files-secure.s3.us-west-2.amazonaws.com/3acbc979-3f43-48f4-8683-229c6104ec76/9bfed593-cd6b-438a-9bbc-f486f95d1e0d/image.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=ASIAZI2LB466UKSS5BAW%2F20250810%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20250810T113502Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJv%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJIMEYCIQCyqXwGTDP4S29JhLtZ9oqf7yovwew1VJu6EZpe%2FcFezQIhAOLbIBX9RQTjEPk3SbK4Ct6o6vqrEL2OEqAzXvR81VxfKogECNT%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEQABoMNjM3NDIzMTgzODA1Igxpx%2F8nNI4tSu2lnDoq3AN0C9bAgKvlZNPuFeJt5vM1GRs4MuoUO8TL%2FavUSorZgz6NUfTb6nTOjQITGrH8RfSECQskXmN4bdn7kk4jF%2B%2FpgDr9EgLOy%2FkNGgQIuIX5AmQP4j2wDSJq7XlrvbeXs7PD2z2OkEiEMDsptlfJpeKaYqF612hJrF3ILmDlkXkrO7K2rASaD1nqIO5S%2BoQa5VxFEo%2FE24oWcoliqNIFxJGMofch1WtCTN6HYYQeqbzrK83WVKosEwJAsTp6uJNzBXF1MRQOMFUkQOazPJGTTMQj5k5yL%2FQPZZLW0WxgOrV3DJM3qQMmCdvI%2F2X6Evvw%2F1Jk%2Bd2jBxtphgfqEGPc3kVFz4MdUfU%2FmkZsLKIB8IaGFH1%2BitSb8Gyo7hvNEwDQtXncxabpheWA95GFzlMRqLUY2nVVfxuTV5K6EUwCuN5yrAqm5eeKCduVKBODvA0Y7qP9r0aQUNESsIlYayAaEev0CWxo2IUnli3jeGgRfo6v4GsADe5Vmz7nVw%2FtY5YLNHel5k0wi1VxLEMagP68a8qRyMt3FzGcHQMe7oKYz%2FRFghaGu0DwUxGv%2FMQNMmHBEYemzktXjKa6TQkse9dqXnqQc4K%2FS5G8VzIqpQ%2FIMumf%2B%2FRe1f1Fr1NUNLImNzDO%2FuHEBjqkAcJUJS%2B2zL%2B3lcSFkg41yDaKtVqFyYNJ%2Fw510RgOTYYBfr9nhYXbtLUYGv6LwJNBa6plJgy8xQnylbEA%2FUABG0h9yzMy2lDZ9EaIQ0T3aHeSQTgxDl9WgjSPlY%2B4oTWwX74D%2BxTCt%2FTvg0gBLjRrsOwmN6UfO7yQhInnnGtf4QCHrDOnRzrF9gzlfpVKjOQ7icfETD70edqfTgTLIwwKKbwAOoTg&X-Amz-Signature=4dfd75b5e25ab39a21f821d0d30bb846f6fec308068940331f9625d8c99db1d6&X-Amz-SignedHeaders=host&x-amz-checksum-mode=ENABLED&x-id=GetObject)

- Pros: 연산해야 하는 representation이 새롭게 입력된 last token으로 매우 효율적

- Cons: 이전 시점의 모든 layer의 모든 k, v를 저장해야 함

Multi-head Latent Attention

- basic idea: caching 해야 하는 representaiton을 줄이고, 조금만 더 연산해보자

![Image](https://prod-files-secure.s3.us-west-2.amazonaws.com/3acbc979-3f43-48f4-8683-229c6104ec76/460e5ab2-3d21-4531-a738-c819a7a59fc8/image.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=ASIAZI2LB466UKSS5BAW%2F20250810%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20250810T113502Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJv%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJIMEYCIQCyqXwGTDP4S29JhLtZ9oqf7yovwew1VJu6EZpe%2FcFezQIhAOLbIBX9RQTjEPk3SbK4Ct6o6vqrEL2OEqAzXvR81VxfKogECNT%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEQABoMNjM3NDIzMTgzODA1Igxpx%2F8nNI4tSu2lnDoq3AN0C9bAgKvlZNPuFeJt5vM1GRs4MuoUO8TL%2FavUSorZgz6NUfTb6nTOjQITGrH8RfSECQskXmN4bdn7kk4jF%2B%2FpgDr9EgLOy%2FkNGgQIuIX5AmQP4j2wDSJq7XlrvbeXs7PD2z2OkEiEMDsptlfJpeKaYqF612hJrF3ILmDlkXkrO7K2rASaD1nqIO5S%2BoQa5VxFEo%2FE24oWcoliqNIFxJGMofch1WtCTN6HYYQeqbzrK83WVKosEwJAsTp6uJNzBXF1MRQOMFUkQOazPJGTTMQj5k5yL%2FQPZZLW0WxgOrV3DJM3qQMmCdvI%2F2X6Evvw%2F1Jk%2Bd2jBxtphgfqEGPc3kVFz4MdUfU%2FmkZsLKIB8IaGFH1%2BitSb8Gyo7hvNEwDQtXncxabpheWA95GFzlMRqLUY2nVVfxuTV5K6EUwCuN5yrAqm5eeKCduVKBODvA0Y7qP9r0aQUNESsIlYayAaEev0CWxo2IUnli3jeGgRfo6v4GsADe5Vmz7nVw%2FtY5YLNHel5k0wi1VxLEMagP68a8qRyMt3FzGcHQMe7oKYz%2FRFghaGu0DwUxGv%2FMQNMmHBEYemzktXjKa6TQkse9dqXnqQc4K%2FS5G8VzIqpQ%2FIMumf%2B%2FRe1f1Fr1NUNLImNzDO%2FuHEBjqkAcJUJS%2B2zL%2B3lcSFkg41yDaKtVqFyYNJ%2Fw510RgOTYYBfr9nhYXbtLUYGv6LwJNBa6plJgy8xQnylbEA%2FUABG0h9yzMy2lDZ9EaIQ0T3aHeSQTgxDl9WgjSPlY%2B4oTWwX74D%2BxTCt%2FTvg0gBLjRrsOwmN6UfO7yQhInnnGtf4QCHrDOnRzrF9gzlfpVKjOQ7icfETD70edqfTgTLIwwKKbwAOoTg&X-Amz-Signature=aa330b38c0b5d08231a6f72c0b00330c5b391a971d6bff6af96f3726b1e78c57&X-Amz-SignedHeaders=host&x-amz-checksum-mode=ENABLED&x-id=GetObject)

- (eq1) c: k, v를 생성하는 compressed latent vector (512 차원)

- (eq3) RoPE가 적용된 k vector를 별도로 생성하여 저장

- (eq2, 5)cached c vector로부터 head 별 다른 projection matrix를 이용하여 k, v 생성

- (eq3) RoPE 적용을 위해 RoPE 적용 k와 기존 k를 concat하여 사용

- 실제 attention 작업 시에는 기존 masked self attention과 동일하게 진행

## 2-2. Training Loss

### 2-2-1. Auxiliary-Loss-Free Load Balancing

- Load Balancing: MoE 구조 학습 시 각 expert 들이 비슷한 횟수만큼 학습에 활용될 수 있는 장치

- 기존 해결책: Auxiliary Loss를 이용하여 각 expert의 선택 분포를 uniform하도록 제한

- DeepSeek v3: 각 expert에 대한 bias term을 도입하여 affinity score 계산 시 활용 

- bias term은 end-to-end 학습 대상 X

### 2-2-2. Complementary Sequence-Wise Auxiliary Loss

![Image](https://prod-files-secure.s3.us-west-2.amazonaws.com/3acbc979-3f43-48f4-8683-229c6104ec76/003eb361-a378-4dc4-aceb-84f8214a3278/image.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=ASIAZI2LB466UKSS5BAW%2F20250810%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20250810T113502Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJv%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJIMEYCIQCyqXwGTDP4S29JhLtZ9oqf7yovwew1VJu6EZpe%2FcFezQIhAOLbIBX9RQTjEPk3SbK4Ct6o6vqrEL2OEqAzXvR81VxfKogECNT%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEQABoMNjM3NDIzMTgzODA1Igxpx%2F8nNI4tSu2lnDoq3AN0C9bAgKvlZNPuFeJt5vM1GRs4MuoUO8TL%2FavUSorZgz6NUfTb6nTOjQITGrH8RfSECQskXmN4bdn7kk4jF%2B%2FpgDr9EgLOy%2FkNGgQIuIX5AmQP4j2wDSJq7XlrvbeXs7PD2z2OkEiEMDsptlfJpeKaYqF612hJrF3ILmDlkXkrO7K2rASaD1nqIO5S%2BoQa5VxFEo%2FE24oWcoliqNIFxJGMofch1WtCTN6HYYQeqbzrK83WVKosEwJAsTp6uJNzBXF1MRQOMFUkQOazPJGTTMQj5k5yL%2FQPZZLW0WxgOrV3DJM3qQMmCdvI%2F2X6Evvw%2F1Jk%2Bd2jBxtphgfqEGPc3kVFz4MdUfU%2FmkZsLKIB8IaGFH1%2BitSb8Gyo7hvNEwDQtXncxabpheWA95GFzlMRqLUY2nVVfxuTV5K6EUwCuN5yrAqm5eeKCduVKBODvA0Y7qP9r0aQUNESsIlYayAaEev0CWxo2IUnli3jeGgRfo6v4GsADe5Vmz7nVw%2FtY5YLNHel5k0wi1VxLEMagP68a8qRyMt3FzGcHQMe7oKYz%2FRFghaGu0DwUxGv%2FMQNMmHBEYemzktXjKa6TQkse9dqXnqQc4K%2FS5G8VzIqpQ%2FIMumf%2B%2FRe1f1Fr1NUNLImNzDO%2FuHEBjqkAcJUJS%2B2zL%2B3lcSFkg41yDaKtVqFyYNJ%2Fw510RgOTYYBfr9nhYXbtLUYGv6LwJNBa6plJgy8xQnylbEA%2FUABG0h9yzMy2lDZ9EaIQ0T3aHeSQTgxDl9WgjSPlY%2B4oTWwX74D%2BxTCt%2FTvg0gBLjRrsOwmN6UfO7yQhInnnGtf4QCHrDOnRzrF9gzlfpVKjOQ7icfETD70edqfTgTLIwwKKbwAOoTg&X-Amz-Signature=e122ac7cbbf9715e661d74e75e8e786582ab406013e39e331ab0f595c8c89f84&X-Amz-SignedHeaders=host&x-amz-checksum-mode=ENABLED&x-id=GetObject)

- 여전히 load imbalance 문제가 발생할 수 있음 → 특히 한 sequence 내에서!

- 하나의 sequence 내에서도 Load balance 하도록 auxiliary loss term 도입

### 2-2-3. Multi-Token Prediction

- MTP: pretrain 시 next token 외에도 t+k 시점의 미래 시점 토큰도 함께 예측하도록 학습하는 것 

![Image](https://prod-files-secure.s3.us-west-2.amazonaws.com/3acbc979-3f43-48f4-8683-229c6104ec76/0ed2664d-27be-49f2-878b-5dec484f9e79/image.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=ASIAZI2LB466UKSS5BAW%2F20250810%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20250810T113503Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJv%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJIMEYCIQCyqXwGTDP4S29JhLtZ9oqf7yovwew1VJu6EZpe%2FcFezQIhAOLbIBX9RQTjEPk3SbK4Ct6o6vqrEL2OEqAzXvR81VxfKogECNT%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEQABoMNjM3NDIzMTgzODA1Igxpx%2F8nNI4tSu2lnDoq3AN0C9bAgKvlZNPuFeJt5vM1GRs4MuoUO8TL%2FavUSorZgz6NUfTb6nTOjQITGrH8RfSECQskXmN4bdn7kk4jF%2B%2FpgDr9EgLOy%2FkNGgQIuIX5AmQP4j2wDSJq7XlrvbeXs7PD2z2OkEiEMDsptlfJpeKaYqF612hJrF3ILmDlkXkrO7K2rASaD1nqIO5S%2BoQa5VxFEo%2FE24oWcoliqNIFxJGMofch1WtCTN6HYYQeqbzrK83WVKosEwJAsTp6uJNzBXF1MRQOMFUkQOazPJGTTMQj5k5yL%2FQPZZLW0WxgOrV3DJM3qQMmCdvI%2F2X6Evvw%2F1Jk%2Bd2jBxtphgfqEGPc3kVFz4MdUfU%2FmkZsLKIB8IaGFH1%2BitSb8Gyo7hvNEwDQtXncxabpheWA95GFzlMRqLUY2nVVfxuTV5K6EUwCuN5yrAqm5eeKCduVKBODvA0Y7qP9r0aQUNESsIlYayAaEev0CWxo2IUnli3jeGgRfo6v4GsADe5Vmz7nVw%2FtY5YLNHel5k0wi1VxLEMagP68a8qRyMt3FzGcHQMe7oKYz%2FRFghaGu0DwUxGv%2FMQNMmHBEYemzktXjKa6TQkse9dqXnqQc4K%2FS5G8VzIqpQ%2FIMumf%2B%2FRe1f1Fr1NUNLImNzDO%2FuHEBjqkAcJUJS%2B2zL%2B3lcSFkg41yDaKtVqFyYNJ%2Fw510RgOTYYBfr9nhYXbtLUYGv6LwJNBa6plJgy8xQnylbEA%2FUABG0h9yzMy2lDZ9EaIQ0T3aHeSQTgxDl9WgjSPlY%2B4oTWwX74D%2BxTCt%2FTvg0gBLjRrsOwmN6UfO7yQhInnnGtf4QCHrDOnRzrF9gzlfpVKjOQ7icfETD70edqfTgTLIwwKKbwAOoTg&X-Amz-Signature=2c89a62c2919a5113f3de10d7d04f6d545555803951151c68c97ab36fc22184d&X-Amz-SignedHeaders=host&x-amz-checksum-mode=ENABLED&x-id=GetObject)

- 원 MTP 논문과 달리 MTP Module 도입

![Image](https://prod-files-secure.s3.us-west-2.amazonaws.com/3acbc979-3f43-48f4-8683-229c6104ec76/d557a831-0fc1-411d-9fc5-442f825a0c87/image.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=ASIAZI2LB466UKSS5BAW%2F20250810%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20250810T113503Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJv%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJIMEYCIQCyqXwGTDP4S29JhLtZ9oqf7yovwew1VJu6EZpe%2FcFezQIhAOLbIBX9RQTjEPk3SbK4Ct6o6vqrEL2OEqAzXvR81VxfKogECNT%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEQABoMNjM3NDIzMTgzODA1Igxpx%2F8nNI4tSu2lnDoq3AN0C9bAgKvlZNPuFeJt5vM1GRs4MuoUO8TL%2FavUSorZgz6NUfTb6nTOjQITGrH8RfSECQskXmN4bdn7kk4jF%2B%2FpgDr9EgLOy%2FkNGgQIuIX5AmQP4j2wDSJq7XlrvbeXs7PD2z2OkEiEMDsptlfJpeKaYqF612hJrF3ILmDlkXkrO7K2rASaD1nqIO5S%2BoQa5VxFEo%2FE24oWcoliqNIFxJGMofch1WtCTN6HYYQeqbzrK83WVKosEwJAsTp6uJNzBXF1MRQOMFUkQOazPJGTTMQj5k5yL%2FQPZZLW0WxgOrV3DJM3qQMmCdvI%2F2X6Evvw%2F1Jk%2Bd2jBxtphgfqEGPc3kVFz4MdUfU%2FmkZsLKIB8IaGFH1%2BitSb8Gyo7hvNEwDQtXncxabpheWA95GFzlMRqLUY2nVVfxuTV5K6EUwCuN5yrAqm5eeKCduVKBODvA0Y7qP9r0aQUNESsIlYayAaEev0CWxo2IUnli3jeGgRfo6v4GsADe5Vmz7nVw%2FtY5YLNHel5k0wi1VxLEMagP68a8qRyMt3FzGcHQMe7oKYz%2FRFghaGu0DwUxGv%2FMQNMmHBEYemzktXjKa6TQkse9dqXnqQc4K%2FS5G8VzIqpQ%2FIMumf%2B%2FRe1f1Fr1NUNLImNzDO%2FuHEBjqkAcJUJS%2B2zL%2B3lcSFkg41yDaKtVqFyYNJ%2Fw510RgOTYYBfr9nhYXbtLUYGv6LwJNBa6plJgy8xQnylbEA%2FUABG0h9yzMy2lDZ9EaIQ0T3aHeSQTgxDl9WgjSPlY%2B4oTWwX74D%2BxTCt%2FTvg0gBLjRrsOwmN6UfO7yQhInnnGtf4QCHrDOnRzrF9gzlfpVKjOQ7icfETD70edqfTgTLIwwKKbwAOoTg&X-Amz-Signature=1ff4aa15573b620f5577da95ca217d069819a3faa24441c434cd9f82f6c7250f&X-Amz-SignedHeaders=host&x-amz-checksum-mode=ENABLED&x-id=GetObject)

![Image](https://prod-files-secure.s3.us-west-2.amazonaws.com/3acbc979-3f43-48f4-8683-229c6104ec76/10b19100-6da6-4293-b0c1-da46865379e7/image.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=ASIAZI2LB466UKSS5BAW%2F20250810%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20250810T113503Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJv%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJIMEYCIQCyqXwGTDP4S29JhLtZ9oqf7yovwew1VJu6EZpe%2FcFezQIhAOLbIBX9RQTjEPk3SbK4Ct6o6vqrEL2OEqAzXvR81VxfKogECNT%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEQABoMNjM3NDIzMTgzODA1Igxpx%2F8nNI4tSu2lnDoq3AN0C9bAgKvlZNPuFeJt5vM1GRs4MuoUO8TL%2FavUSorZgz6NUfTb6nTOjQITGrH8RfSECQskXmN4bdn7kk4jF%2B%2FpgDr9EgLOy%2FkNGgQIuIX5AmQP4j2wDSJq7XlrvbeXs7PD2z2OkEiEMDsptlfJpeKaYqF612hJrF3ILmDlkXkrO7K2rASaD1nqIO5S%2BoQa5VxFEo%2FE24oWcoliqNIFxJGMofch1WtCTN6HYYQeqbzrK83WVKosEwJAsTp6uJNzBXF1MRQOMFUkQOazPJGTTMQj5k5yL%2FQPZZLW0WxgOrV3DJM3qQMmCdvI%2F2X6Evvw%2F1Jk%2Bd2jBxtphgfqEGPc3kVFz4MdUfU%2FmkZsLKIB8IaGFH1%2BitSb8Gyo7hvNEwDQtXncxabpheWA95GFzlMRqLUY2nVVfxuTV5K6EUwCuN5yrAqm5eeKCduVKBODvA0Y7qP9r0aQUNESsIlYayAaEev0CWxo2IUnli3jeGgRfo6v4GsADe5Vmz7nVw%2FtY5YLNHel5k0wi1VxLEMagP68a8qRyMt3FzGcHQMe7oKYz%2FRFghaGu0DwUxGv%2FMQNMmHBEYemzktXjKa6TQkse9dqXnqQc4K%2FS5G8VzIqpQ%2FIMumf%2B%2FRe1f1Fr1NUNLImNzDO%2FuHEBjqkAcJUJS%2B2zL%2B3lcSFkg41yDaKtVqFyYNJ%2Fw510RgOTYYBfr9nhYXbtLUYGv6LwJNBa6plJgy8xQnylbEA%2FUABG0h9yzMy2lDZ9EaIQ0T3aHeSQTgxDl9WgjSPlY%2B4oTWwX74D%2BxTCt%2FTvg0gBLjRrsOwmN6UfO7yQhInnnGtf4QCHrDOnRzrF9gzlfpVKjOQ7icfETD70edqfTgTLIwwKKbwAOoTg&X-Amz-Signature=790d53ebe1af678cc5c350da73f2ed85ed43f59241b6c5aec1960d3c38d63026&X-Amz-SignedHeaders=host&x-amz-checksum-mode=ENABLED&x-id=GetObject)

![Image](https://prod-files-secure.s3.us-west-2.amazonaws.com/3acbc979-3f43-48f4-8683-229c6104ec76/a9aa56e4-1cd7-4e0b-bece-a4ce6f6a34e8/image.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=ASIAZI2LB466UKSS5BAW%2F20250810%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20250810T113503Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJv%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJIMEYCIQCyqXwGTDP4S29JhLtZ9oqf7yovwew1VJu6EZpe%2FcFezQIhAOLbIBX9RQTjEPk3SbK4Ct6o6vqrEL2OEqAzXvR81VxfKogECNT%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEQABoMNjM3NDIzMTgzODA1Igxpx%2F8nNI4tSu2lnDoq3AN0C9bAgKvlZNPuFeJt5vM1GRs4MuoUO8TL%2FavUSorZgz6NUfTb6nTOjQITGrH8RfSECQskXmN4bdn7kk4jF%2B%2FpgDr9EgLOy%2FkNGgQIuIX5AmQP4j2wDSJq7XlrvbeXs7PD2z2OkEiEMDsptlfJpeKaYqF612hJrF3ILmDlkXkrO7K2rASaD1nqIO5S%2BoQa5VxFEo%2FE24oWcoliqNIFxJGMofch1WtCTN6HYYQeqbzrK83WVKosEwJAsTp6uJNzBXF1MRQOMFUkQOazPJGTTMQj5k5yL%2FQPZZLW0WxgOrV3DJM3qQMmCdvI%2F2X6Evvw%2F1Jk%2Bd2jBxtphgfqEGPc3kVFz4MdUfU%2FmkZsLKIB8IaGFH1%2BitSb8Gyo7hvNEwDQtXncxabpheWA95GFzlMRqLUY2nVVfxuTV5K6EUwCuN5yrAqm5eeKCduVKBODvA0Y7qP9r0aQUNESsIlYayAaEev0CWxo2IUnli3jeGgRfo6v4GsADe5Vmz7nVw%2FtY5YLNHel5k0wi1VxLEMagP68a8qRyMt3FzGcHQMe7oKYz%2FRFghaGu0DwUxGv%2FMQNMmHBEYemzktXjKa6TQkse9dqXnqQc4K%2FS5G8VzIqpQ%2FIMumf%2B%2FRe1f1Fr1NUNLImNzDO%2FuHEBjqkAcJUJS%2B2zL%2B3lcSFkg41yDaKtVqFyYNJ%2Fw510RgOTYYBfr9nhYXbtLUYGv6LwJNBa6plJgy8xQnylbEA%2FUABG0h9yzMy2lDZ9EaIQ0T3aHeSQTgxDl9WgjSPlY%2B4oTWwX74D%2BxTCt%2FTvg0gBLjRrsOwmN6UfO7yQhInnnGtf4QCHrDOnRzrF9gzlfpVKjOQ7icfETD70edqfTgTLIwwKKbwAOoTg&X-Amz-Signature=c31ceee0c0c6e05ebe5655bfe004ca09138a773cc0b8a780dc5c8d55c99b3555&X-Amz-SignedHeaders=host&x-amz-checksum-mode=ENABLED&x-id=GetObject)

**Forwarding Process (MTP Module 2)**

1. module 1의 last hidden representation을 가지고 와서 RMSNorm 통과

1. t+1번째 token부터 embedding layer에 통과시켜 representation 획득 → t+2 시점의 단어 예측을 위한 추가 정보로서 활용하는 듯

1. 1과 2의 representation을 concat하여 transformer layer 및 LM Head를 통과시켜 예측 진행

# 3. Pretraining

## 3-1. Data

- 이 놈들이 데이터를 어떻게 수집했는지 밝히지 않고 있습니다… 

- 수학 및 코딩 데이터의 비중 증가

- 중국어 및 영어를 포함한 다양한 언어 데이터 포괄

### Fill-in-Middle strategy (이미 기존에 공개된 논문)

![Image](https://prod-files-secure.s3.us-west-2.amazonaws.com/3acbc979-3f43-48f4-8683-229c6104ec76/3a4a6596-416a-4014-ad36-57fec0b953ee/image.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=ASIAZI2LB466UKSS5BAW%2F20250810%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20250810T113503Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJv%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJIMEYCIQCyqXwGTDP4S29JhLtZ9oqf7yovwew1VJu6EZpe%2FcFezQIhAOLbIBX9RQTjEPk3SbK4Ct6o6vqrEL2OEqAzXvR81VxfKogECNT%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEQABoMNjM3NDIzMTgzODA1Igxpx%2F8nNI4tSu2lnDoq3AN0C9bAgKvlZNPuFeJt5vM1GRs4MuoUO8TL%2FavUSorZgz6NUfTb6nTOjQITGrH8RfSECQskXmN4bdn7kk4jF%2B%2FpgDr9EgLOy%2FkNGgQIuIX5AmQP4j2wDSJq7XlrvbeXs7PD2z2OkEiEMDsptlfJpeKaYqF612hJrF3ILmDlkXkrO7K2rASaD1nqIO5S%2BoQa5VxFEo%2FE24oWcoliqNIFxJGMofch1WtCTN6HYYQeqbzrK83WVKosEwJAsTp6uJNzBXF1MRQOMFUkQOazPJGTTMQj5k5yL%2FQPZZLW0WxgOrV3DJM3qQMmCdvI%2F2X6Evvw%2F1Jk%2Bd2jBxtphgfqEGPc3kVFz4MdUfU%2FmkZsLKIB8IaGFH1%2BitSb8Gyo7hvNEwDQtXncxabpheWA95GFzlMRqLUY2nVVfxuTV5K6EUwCuN5yrAqm5eeKCduVKBODvA0Y7qP9r0aQUNESsIlYayAaEev0CWxo2IUnli3jeGgRfo6v4GsADe5Vmz7nVw%2FtY5YLNHel5k0wi1VxLEMagP68a8qRyMt3FzGcHQMe7oKYz%2FRFghaGu0DwUxGv%2FMQNMmHBEYemzktXjKa6TQkse9dqXnqQc4K%2FS5G8VzIqpQ%2FIMumf%2B%2FRe1f1Fr1NUNLImNzDO%2FuHEBjqkAcJUJS%2B2zL%2B3lcSFkg41yDaKtVqFyYNJ%2Fw510RgOTYYBfr9nhYXbtLUYGv6LwJNBa6plJgy8xQnylbEA%2FUABG0h9yzMy2lDZ9EaIQ0T3aHeSQTgxDl9WgjSPlY%2B4oTWwX74D%2BxTCt%2FTvg0gBLjRrsOwmN6UfO7yQhInnnGtf4QCHrDOnRzrF9gzlfpVKjOQ7icfETD70edqfTgTLIwwKKbwAOoTg&X-Amz-Signature=9485e9821e0a99753ce159352a295b64d49ba42170381a0fd3a238a88076d596&X-Amz-SignedHeaders=host&x-amz-checksum-mode=ENABLED&x-id=GetObject)

- Decoder-only 모델에게 문장의 시작(prefix)와 끝(suffix)를 주고 중간 부분을 생성하도록 시키는 것

- BPE 토크나이저를 사용하여 128K 보캡 구축

## 3-2. Long Context Extension

- 학습 효율화를 위해 context window 길이를 4k(14.8T token) → 23k(1000 step) → 128k(1000 step)로 점차적으로 확장

- YaRN 방식을 이용하여 extension 학습 진행

# 4. Post-Training

- RLHF 등의 학습을 진행하기 위한 레시피 제시 

## SFT

### 4-1. Reasoning Data

- 고품질의 reasoning data 확보를 위해 DeepSeek-R1 모델 활용 → R1 논문에서 자세히 소개 

- 코드/수학 등의 도메인에 대한 고품질 데이터 확보를 위해 각 도메인 별 expert 모델 학습

### 4-2. Non-Reasoning Data

- reasoning이 필요없는 creative writing 데이터는 이전 모델(DeepSeek-V2.5)를 통해 답변 생성

## RL

### 4-3. Reward Model

- Rule-based RM과 Model-based RM을 혼용하여 사용 

- GRPO를 통해 학습 진행

![Image](https://prod-files-secure.s3.us-west-2.amazonaws.com/3acbc979-3f43-48f4-8683-229c6104ec76/9175529c-6675-4f68-a314-f841d5a345e8/image.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=ASIAZI2LB466UKSS5BAW%2F20250810%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20250810T113503Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJv%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJIMEYCIQCyqXwGTDP4S29JhLtZ9oqf7yovwew1VJu6EZpe%2FcFezQIhAOLbIBX9RQTjEPk3SbK4Ct6o6vqrEL2OEqAzXvR81VxfKogECNT%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEQABoMNjM3NDIzMTgzODA1Igxpx%2F8nNI4tSu2lnDoq3AN0C9bAgKvlZNPuFeJt5vM1GRs4MuoUO8TL%2FavUSorZgz6NUfTb6nTOjQITGrH8RfSECQskXmN4bdn7kk4jF%2B%2FpgDr9EgLOy%2FkNGgQIuIX5AmQP4j2wDSJq7XlrvbeXs7PD2z2OkEiEMDsptlfJpeKaYqF612hJrF3ILmDlkXkrO7K2rASaD1nqIO5S%2BoQa5VxFEo%2FE24oWcoliqNIFxJGMofch1WtCTN6HYYQeqbzrK83WVKosEwJAsTp6uJNzBXF1MRQOMFUkQOazPJGTTMQj5k5yL%2FQPZZLW0WxgOrV3DJM3qQMmCdvI%2F2X6Evvw%2F1Jk%2Bd2jBxtphgfqEGPc3kVFz4MdUfU%2FmkZsLKIB8IaGFH1%2BitSb8Gyo7hvNEwDQtXncxabpheWA95GFzlMRqLUY2nVVfxuTV5K6EUwCuN5yrAqm5eeKCduVKBODvA0Y7qP9r0aQUNESsIlYayAaEev0CWxo2IUnli3jeGgRfo6v4GsADe5Vmz7nVw%2FtY5YLNHel5k0wi1VxLEMagP68a8qRyMt3FzGcHQMe7oKYz%2FRFghaGu0DwUxGv%2FMQNMmHBEYemzktXjKa6TQkse9dqXnqQc4K%2FS5G8VzIqpQ%2FIMumf%2B%2FRe1f1Fr1NUNLImNzDO%2FuHEBjqkAcJUJS%2B2zL%2B3lcSFkg41yDaKtVqFyYNJ%2Fw510RgOTYYBfr9nhYXbtLUYGv6LwJNBa6plJgy8xQnylbEA%2FUABG0h9yzMy2lDZ9EaIQ0T3aHeSQTgxDl9WgjSPlY%2B4oTWwX74D%2BxTCt%2FTvg0gBLjRrsOwmN6UfO7yQhInnnGtf4QCHrDOnRzrF9gzlfpVKjOQ7icfETD70edqfTgTLIwwKKbwAOoTg&X-Amz-Signature=735a471bd8725ab0ced14a11fb5eb2214547530ec8a7ab957bf0589e998f29f4&X-Amz-SignedHeaders=host&x-amz-checksum-mode=ENABLED&x-id=GetObject)

![Image](https://prod-files-secure.s3.us-west-2.amazonaws.com/3acbc979-3f43-48f4-8683-229c6104ec76/7047df77-be33-4818-9ac1-4475f2dc4599/image.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=ASIAZI2LB466UKSS5BAW%2F20250810%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20250810T113503Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJv%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJIMEYCIQCyqXwGTDP4S29JhLtZ9oqf7yovwew1VJu6EZpe%2FcFezQIhAOLbIBX9RQTjEPk3SbK4Ct6o6vqrEL2OEqAzXvR81VxfKogECNT%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEQABoMNjM3NDIzMTgzODA1Igxpx%2F8nNI4tSu2lnDoq3AN0C9bAgKvlZNPuFeJt5vM1GRs4MuoUO8TL%2FavUSorZgz6NUfTb6nTOjQITGrH8RfSECQskXmN4bdn7kk4jF%2B%2FpgDr9EgLOy%2FkNGgQIuIX5AmQP4j2wDSJq7XlrvbeXs7PD2z2OkEiEMDsptlfJpeKaYqF612hJrF3ILmDlkXkrO7K2rASaD1nqIO5S%2BoQa5VxFEo%2FE24oWcoliqNIFxJGMofch1WtCTN6HYYQeqbzrK83WVKosEwJAsTp6uJNzBXF1MRQOMFUkQOazPJGTTMQj5k5yL%2FQPZZLW0WxgOrV3DJM3qQMmCdvI%2F2X6Evvw%2F1Jk%2Bd2jBxtphgfqEGPc3kVFz4MdUfU%2FmkZsLKIB8IaGFH1%2BitSb8Gyo7hvNEwDQtXncxabpheWA95GFzlMRqLUY2nVVfxuTV5K6EUwCuN5yrAqm5eeKCduVKBODvA0Y7qP9r0aQUNESsIlYayAaEev0CWxo2IUnli3jeGgRfo6v4GsADe5Vmz7nVw%2FtY5YLNHel5k0wi1VxLEMagP68a8qRyMt3FzGcHQMe7oKYz%2FRFghaGu0DwUxGv%2FMQNMmHBEYemzktXjKa6TQkse9dqXnqQc4K%2FS5G8VzIqpQ%2FIMumf%2B%2FRe1f1Fr1NUNLImNzDO%2FuHEBjqkAcJUJS%2B2zL%2B3lcSFkg41yDaKtVqFyYNJ%2Fw510RgOTYYBfr9nhYXbtLUYGv6LwJNBa6plJgy8xQnylbEA%2FUABG0h9yzMy2lDZ9EaIQ0T3aHeSQTgxDl9WgjSPlY%2B4oTWwX74D%2BxTCt%2FTvg0gBLjRrsOwmN6UfO7yQhInnnGtf4QCHrDOnRzrF9gzlfpVKjOQ7icfETD70edqfTgTLIwwKKbwAOoTg&X-Amz-Signature=8ba18f4cf8b4a9d2ba6ae46a3294133c2b22b484150fa8dcf329bf9ccb97f7be&X-Amz-SignedHeaders=host&x-amz-checksum-mode=ENABLED&x-id=GetObject)

# 5. Experiments

## Pretrain

- 성능 킹왕짱!
